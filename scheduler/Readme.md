## Планировщик автоматических событий

Модуль запускается cron по расписанию, например, каждые 5 минут.
Для рассылок, требующих немедленной отправки, модуль запускается директивно по сигналу django о сохранении такой задачи 
рассылки в базу данных.
Модуль запрашивает из базы данных задачи рассылки со статусом "Pending" и плановым временем исполнения меньше 
текущего времени. 
На основании списков фильтров в поле "user_categories" словаря "context" модуль запрашивает список ids пользователей,
удовлетворяющих данным условиям в AuthAPI. Если заданы другие поля и в модуле настроены их обработчики для запроса данных 
из смежных сервисов (например, запрос информации о фильмах, обложке, жанрах, годе выпуска и др.), осуществляются 
соответствующие запросы в смежные сервисы.

Если список пользователей превышает максимальное значение, установленное для уведомления, то он разбивается на части.
При этом информация об общем количестве частей и номере текущей части указывается в формируемом уведомлении для отправки 
в сервис Notification API.

Входные данные для модуля:
```json
{
  "id": "5c1bac6d-f508-4ce7-988a-25f2f4e17a77",
  "created_at": "2022-05-10T20:22:32.477Z",
  "updated_at": "2022-05-10T20:36:48.811Z",
  "title": "Еженедельная рассылка за 19 неделю 2022",
  "type_mailing": "To scheduled send",
  "status": "Pending",
  "is_promo": true,
  "priority": "low",
  "template": "91b5a97a-c20b-4665-9624-a49033d387af",
  "context": {
    "user_categories": [
      "active"
    ]
  },
  "scheduled_datetime": "2022-05-13T18:00:00Z",
  "repeat_frequency": "weekly",
  "execution_datetime": null
}
```

Содержание тела запроса для направления в сервис Notification API:
- для случая с разбиение на части:
```json
{
  "mailing_id": "5c1bac6d-f508-4ce7-988a-25f2f4e17a77",
  "total_chunk": 21,
  "chunk_id": 3,
  "title": "Еженедельная рассылка за 19 неделю 2022",
  "is_promo": true,
  "priority": "low",
  "template": "91b5a97a-c20b-4665-9624-a49033d387af",
  "context": {},
  "user_ids": [
    "6567ebaf-0f96-407b-81ad-03670dc3333d",
    "a4aa603a-5b87-4109-a404-4a3ed4b8ef39",
    "986880f0-9b77-4c7f-aa24-a01830e254a2",
    "9a2170c3-53fc-4395-ba3d-a6fffada5eaa",
    "fb2cf3ab-1ff3-46e0-b6a0-e91b688797ce",
    "178ba787-0c57-4d6a-b9ae-cf84081eb3d8",
    "c6120360-4bf8-4941-aa5d-23669fef9422",
    "b2bd34e7-b976-4e09-8e76-8f561505f808",
    "c850237e-252e-4a69-8ed2-775880ff57c7",
    "...",
    "1431e3a3-0f10-469c-96e4-6bad59c8d65e"
  ]
}
```
- для случая с одной частью:
```json
{
  "mailing_id": "5c1bac6d-f508-4ce7-988a-25f2f4e17a77",
  "total_chunk": 1,
  "chunk_id": 1,
  "title": "Еженедельная рассылка за 19 неделю 2022",
  "is_promo": true,
  "priority": "low",
  "template": "91b5a97a-c20b-4665-9624-a49033d387af",
  "context": {},
  "user_ids": [
    "6567ebaf-0f96-407b-81ad-03670dc3333d",
    "a4aa603a-5b87-4109-a404-4a3ed4b8ef39",
    "986880f0-9b77-4c7f-aa24-a01830e254a2",
    "9a2170c3-53fc-4395-ba3d-a6fffada5eaa",
    "fb2cf3ab-1ff3-46e0-b6a0-e91b688797ce",
    "178ba787-0c57-4d6a-b9ae-cf84081eb3d8",
    "c6120360-4bf8-4941-aa5d-23669fef9422",
    "b2bd34e7-b976-4e09-8e76-8f561505f808",
    "c850237e-252e-4a69-8ed2-775880ff57c7",
    "...",
    "1431e3a3-0f10-469c-96e4-6bad59c8d65e"
  ]
}
```

Обработка каждой задачи рассылки и запись всех ее частей уведомлений в Notification API должна осуществляться в рамках одной 
транзакции. В случае ошибки в ходе обработки транзакция должна откатываться, для исключения дублирования уведомлений, 
отправляемых для обработки воркерам. Для этого необходимо предусмотреть контроль успешного получения и обработки планировщиком 
и Notification API всех частей уведомлений обрабатываемой задачи рассылки. В случае успешной обработки задачи рассылки планировщиком
статус задачи рассылки в базе данных меняется на "In processing".